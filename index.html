<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My GitHub Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- ‚úÖ Fixed Firebase scripts: use compat versions -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f9f9f9;
      color: #333;
    }

    #errorDisplay {
      background: #ffdddd;
      color: #900;
      padding: 10px;
      display: none;
      text-align: center;
    }

    header {
      background-color: #007acc;
      color: white;
      padding: 40px 20px;
      text-align: center;
    }

    nav a {
      margin: 0 15px;
      text-decoration: none;
      color: white;
      font-weight: bold;
    }

    .page-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      padding: 40px 5%;
    }

    .left-column,
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .left-column {
      flex: 1;
      max-width: 500px;
    }

    .right-column {
      flex: 1.5;
      max-width: 900px;
    }

    section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 20px;
      position: relative;
    }

    h2 {
      border-bottom: 2px solid #007acc;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input[type="text"], textarea {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }

    input[type="file"] {
      padding: 5px;
    }

    button {
      padding: 10px 20px;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #005fa3;
    }

    #postsContainer {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .post {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 15px;
      position: relative;
    }

    .post img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 10px;
    }

    .timestamp {
      font-size: 0.85em;
      color: #888;
      margin-top: 5px;
    }

    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #e74c3c;
    }

    .delete-btn:hover {
      color: #c0392b;
    }

    .comments {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }

    footer {
      text-align: center;
      padding: 40px 10px;
      font-size: 0.9em;
      color: #777;
      border-top: 1px solid #ccc;
      margin-top: 40px;
    }

    @media screen and (max-width: 900px) {
      .page-content {
        flex-direction: column;
        align-items: center;
      }

      .left-column, .right-column {
        max-width: 90%;
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <div id="errorDisplay"></div>

  <header>
    <h1>Welcome to My GitHub Page</h1>
    <nav>
      <a href="#about">About</a>
      <a href="#projects">Projects</a>
      <a href="#post">Post</a>
    </nav>
  </header>

  <div class="page-content">
    <div class="left-column">
      <section id="about">
        <h2>About Me</h2>
        <p>Hello! I'm a developer passionate about open-source, clean code, and creative UI design.</p>
      </section>

      <section id="projects">
        <h2>Projects</h2>
        <ul></ul>
      </section>
    </div>

    <div class="right-column">
      <section id="post">
        <h2>Create a Post</h2>
        <form id="postForm">
          <input type="text" id="postTitle" placeholder="Post Title" required>
          <textarea id="postContent" rows="5" placeholder="Write something..." required></textarea>
          
          <!-- ‚úÖ Accessible file input -->
          <label for="postImage">Attach an image (optional):</label>
          <input type="file" id="postImage" accept="image/*">

          <button type="submit">Publish</button>
        </form>
        <div id="postsContainer"></div>
      </section>
    </div>
  </div>

  <footer>
    &copy; 2025 Henry Park ‚Äì Built with GitHub Pages
  </footer>

  <script>
  // ================================
  // Firebase (compat) initialization
  // ================================
  const firebaseConfig = {
    apiKey: "AIzaSyCraxKhubAnCTGHqKuCoKRWK8tTtzANGoA",
    authDomain: "githubpage-8c5c3.firebaseapp.com",
    projectId: "githubpage-8c5c3",
    storageBucket: "githubpage-8c5c3.appspot.com",
    messagingSenderId: "142580769287",
    appId: "1:142580769287:web:4fdbd7caa1e2b41174c0a2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ================================
  // DOM refs
  // ================================
  const form = document.getElementById('postForm');
  const postsContainer = document.getElementById('postsContainer');

  // ================================
  // Helpers
  // ================================
  function showError(message) {
    const errorDiv = document.getElementById('errorDisplay');
    errorDiv.textContent = "‚ö†Ô∏è " + message;
    errorDiv.style.display = 'block';
    setTimeout(() => { errorDiv.style.display = 'none'; }, 4000);
  }

  function clearPosts() {
    postsContainer.innerHTML = '';
  }

  function nowTs() {
    return Date.now();
  }

  // Convert legacy string comments to objects {name, text, ts}
  function normalizeComments(arr) {
    const a = Array.isArray(arr) ? arr : [];
    return a.map((c, idx) => {
      if (typeof c === 'string') {
        return { name: 'Guest', text: c, ts: nowTs() + idx }; // stable-ish unique
      }
      // already object; ensure fields
      return {
        name: (c && typeof c.name === 'string' && c.name.trim()) ? c.name.trim() : 'Guest',
        text: (c && typeof c.text === 'string') ? c.text : String(c ?? ''),
        ts: (c && typeof c.ts === 'number') ? c.ts : nowTs()
      };
    });
  }

  // ================================
  // Load posts
  // ================================
  async function loadPosts() {
    try {
      clearPosts();
      const snapshot = await db.collection('posts').orderBy('timestamp', 'desc').get();
      snapshot.forEach(doc => {
        const post = doc.data();
        post.id = doc.id;
        renderPost(post);
      });
    } catch (error) {
      showError("Error loading posts: " + error.message);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadPosts();
    addRandomProject(); // keep your example project adder
  });

  // ================================
  // Random project (unchanged)
  // ================================
  function addRandomProject() {
    const projects = [
      { name: "UR Doctor", link: "https://github.com/HenryPark1206/UR-doctor", desc: "A simple program that helps users to discover their diseases with their symptoms" }
    ];
    const randomProject = projects[Math.floor(Math.random() * projects.length)];
    const projectList = document.querySelector("#projects ul");
    const li = document.createElement("li");
    li.innerHTML = `<a href="${randomProject.link}" target="_blank"><strong>${randomProject.name}</strong></a> - ${randomProject.desc}`;
    projectList.appendChild(li);
  }

  // ================================
  // Create post (password-protected)
  // ================================
  form.addEventListener('submit', async function(event) {
    event.preventDefault();

    const password = prompt("üîí Enter password to publish:");
    if (password !== "qkrtlgn121206") {
      showError("‚ùå Incorrect password. Post not published.");
      return;
    }

    const title = document.getElementById('postTitle').value.trim();
    const content = document.getElementById('postContent').value.trim();
    const imageInput = document.getElementById('postImage');
    const time = new Date().toLocaleString();

    if (!title || !content) {
      showError("Please fill in both title and content.");
      return;
    }

    const newPost = {
      title,
      content,
      timestamp: time,
      image: '',
      comments: [] // will store [{name, text, ts}]
    };

    try {
      if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          newPost.image = e.target.result;
          const docRef = await db.collection('posts').add(newPost);
          newPost.id = docRef.id;
          renderPost(newPost);
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        const docRef = await db.collection('posts').add(newPost);
        newPost.id = docRef.id;
        renderPost(newPost);
      }
    } catch (error) {
      showError("Error publishing post: " + error.message);
    }

    form.reset();
  });

  // ================================
  // Delete a post (password-protected)
  // ================================
  async function deletePost(postId) {
    try {
      await db.collection('posts').doc(postId).delete();
    } catch (error) {
      showError("Error deleting post: " + error.message);
    }
  }

  // ================================
  // Comments UI (with names + delete)
  // ================================
  function createCommentsUI(post) {
    // local state for this post's comments (normalized)
    let commentsState = normalizeComments(post.comments);

    // Wrapper
    const commentsContainer = document.createElement('div');
    commentsContainer.className = 'comments';
    commentsContainer.style.marginTop = '16px';

    // Header
    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.alignItems = 'center';
    header.style.justifyContent = 'space-between';
    header.style.marginBottom = '10px';

    const left = document.createElement('div');
    left.style.display = 'flex';
    left.style.alignItems = 'center';
    left.style.gap = '8px';

    const title = document.createElement('div');
    title.innerHTML = '<i class="fa-regular fa-comments"></i> <strong>Comments</strong>';

    const badge = document.createElement('span');
    badge.style.display = 'inline-block';
    badge.style.fontSize = '12px';
    badge.style.padding = '2px 8px';
    badge.style.borderRadius = '999px';
    badge.style.background = '#eef6ff';
    badge.style.color = '#1e40af';
    badge.textContent = String(commentsState.length);

    left.appendChild(title);
    left.appendChild(badge);

    const toggleBtn = document.createElement('button');
    toggleBtn.type = 'button';
    toggleBtn.textContent = 'Hide';
    toggleBtn.style.all = 'unset';
    toggleBtn.style.cursor = 'pointer';
    toggleBtn.style.padding = '6px 10px';
    toggleBtn.style.border = '1px solid #e5e7eb';
    toggleBtn.style.borderRadius = '8px';
    toggleBtn.style.fontSize = '12px';
    toggleBtn.style.color = '#374151';
    toggleBtn.style.background = '#fff';
    toggleBtn.addEventListener('mouseenter', () => toggleBtn.style.background = '#f9fafb');
    toggleBtn.addEventListener('mouseleave', () => toggleBtn.style.background = '#fff');

    header.appendChild(left);
    header.appendChild(toggleBtn);

    // List
    const listWrapper = document.createElement('div');

    const commentsList = document.createElement('ul');
    commentsList.style.listStyle = 'none';
    commentsList.style.padding = '0';
    commentsList.style.margin = '0';
    commentsList.style.display = 'flex';
    commentsList.style.flexDirection = 'column';
    commentsList.style.gap = '10px';

    const emptyState = document.createElement('div');
    emptyState.style.color = '#6b7280';
    emptyState.style.fontSize = '0.95em';
    emptyState.style.padding = '8px 0';
    emptyState.textContent = 'No comments yet. Be the first to say something!';
    emptyState.style.display = commentsState.length > 0 ? 'none' : 'block';

    // Utility: render one comment row
    function renderCommentItem(c) {
      const li = document.createElement('li');
      li.style.display = 'flex';
      li.style.gap = '10px';
      li.style.alignItems = 'flex-start';
      li.dataset.ts = String(c.ts);

      const avatar = document.createElement('div');
      avatar.textContent = 'üí¨';
      avatar.style.width = '28px';
      avatar.style.flex = 'none';
      avatar.style.textAlign = 'center';

      const bubble = document.createElement('div');
      bubble.style.background = '#f3f4f6';
      bubble.style.border = '1px solid #e5e7eb';
      bubble.style.borderRadius = '8px';
      bubble.style.padding = '8px 10px';
      bubble.style.flex = '1';
      bubble.style.color = '#111827';
      bubble.style.lineHeight = '1.35';
      bubble.textContent = `(${c.name}): ${c.text}`;

      // delete button
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.title = 'Delete comment';
      delBtn.innerHTML = '<i class="fas fa-trash"></i>';
      delBtn.style.border = 'none';
      delBtn.style.background = 'transparent';
      delBtn.style.color = '#e11d48';
      delBtn.style.cursor = 'pointer';
      delBtn.style.fontSize = '14px';
      delBtn.style.marginLeft = '6px';
      delBtn.addEventListener('mouseenter', () => delBtn.style.color = '#be123c');
      delBtn.addEventListener('mouseleave', () => delBtn.style.color = '#e11d48');

      delBtn.addEventListener('click', async () => {
        if (!confirm('Delete this comment?')) return;

        // Remove from local state
        commentsState = commentsState.filter(x => x.ts !== c.ts);

        // Optimistic UI update
        li.remove();
        badge.textContent = String(commentsState.length);
        if (commentsState.length === 0) emptyState.style.display = 'block';

        try {
          // Persist to Firestore
          const postRef = db.collection('posts').doc(post.id);
          await postRef.update({ comments: commentsState });
        } catch (error) {
          showError("Error deleting comment: " + error.message);
        }
      });

      const rightWrap = document.createElement('div');
      rightWrap.style.display = 'flex';
      rightWrap.style.alignItems = 'center';
      rightWrap.style.gap = '6px';
      rightWrap.style.flex = '1';

      rightWrap.appendChild(bubble);
      rightWrap.appendChild(delBtn);

      li.appendChild(avatar);
      li.appendChild(rightWrap);
      commentsList.appendChild(li);
    }

    // Initial render
    commentsState.forEach(renderCommentItem);

    // Input row (name + comment)
    const formRow = document.createElement('form');
    formRow.style.display = 'grid';
    formRow.style.gridTemplateColumns = '160px 1fr auto';
    formRow.style.gap = '8px';
    formRow.style.marginTop = '12px';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = 'Your name';
    nameInput.required = true;
    nameInput.style.padding = '10px';
    nameInput.style.border = '1px solid #d1d5db';
    nameInput.style.borderRadius = '8px';
    nameInput.style.fontSize = '14px';

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Add a comment...';
    input.required = true;
    input.style.padding = '10px';
    input.style.border = '1px solid #d1d5db';
    input.style.borderRadius = '8px';
    input.style.fontSize = '14px';

    const submitBtn = document.createElement('button');
    submitBtn.type = 'submit';
    submitBtn.textContent = 'Post';
    submitBtn.style.padding = '10px 14px';
    submitBtn.style.border = 'none';
    submitBtn.style.borderRadius = '8px';
    submitBtn.style.background = '#007acc';
    submitBtn.style.color = '#fff';
    submitBtn.style.cursor = 'pointer';
    submitBtn.style.fontSize = '14px';
    submitBtn.addEventListener('mouseenter', () => submitBtn.style.background = '#005fa3');
    submitBtn.addEventListener('mouseleave', () => submitBtn.style.background = '#007acc');

    formRow.appendChild(nameInput);
    formRow.appendChild(input);
    formRow.appendChild(submitBtn);

    // Toggle behavior
    let visible = true;
    function updateVisibility() {
      listWrapper.style.display = visible ? 'block' : 'none';
      formRow.style.display = visible ? 'grid' : 'none';
      toggleBtn.textContent = visible ? 'Hide' : 'Show';
    }
    toggleBtn.addEventListener('click', () => {
      visible = !visible;
      updateVisibility();
    });

    // Submit behavior
    formRow.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = (nameInput.value || '').trim() || 'Guest';
      const text = (input.value || '').trim();
      if (!text) return;

      const newItem = { name, text, ts: nowTs() };

      // Optimistic UI
      if (emptyState.style.display !== 'none') emptyState.style.display = 'none';
      commentsState.push(newItem);
      renderCommentItem(newItem);
      nameInput.value = '';
      input.value = '';
      badge.textContent = String(commentsState.length);

      try {
        const postRef = db.collection('posts').doc(post.id);
        await postRef.update({ comments: commentsState });
      } catch (error) {
        showError("Error saving comment: " + error.message);
      }
    });

    listWrapper.appendChild(emptyState);
    listWrapper.appendChild(commentsList);

    commentsContainer.appendChild(header);
    commentsContainer.appendChild(listWrapper);
    commentsContainer.appendChild(formRow);

    // Initial visibility
    updateVisibility();

    return commentsContainer;
  }

  // ================================
  // Render a post (with delete password + new comments UI)
  // ================================
  function renderPost(post) {
    const postDiv = document.createElement('div');
    postDiv.className = 'post';

    const titleEl = document.createElement('h3');
    titleEl.textContent = post.title;

    const contentEl = document.createElement('p');
    contentEl.textContent = post.content;

    const timestampEl = document.createElement('div');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = `Posted on ${post.timestamp}`;

    // Delete button (password-protected)
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
    deleteBtn.onclick = () => {
      const password = prompt("üîí Enter password to delete this post:");
      if (password !== "qkrtlgn121206") {
        showError("‚ùå Incorrect password. Post not deleted.");
        return;
      }
      const confirmDelete = confirm("‚ö†Ô∏è Are you sure you want to delete this post?");
      if (confirmDelete) {
        postDiv.remove();
        deletePost(post.id);
      }
    };

    postDiv.appendChild(deleteBtn);
    postDiv.appendChild(titleEl);
    postDiv.appendChild(contentEl);

    if (post.image) {
      const img = document.createElement('img');
      img.src = post.image;
      postDiv.appendChild(img);
    }

    postDiv.appendChild(timestampEl);

    // Comments (new UI)
    const commentsUI = createCommentsUI(post);
    postDiv.appendChild(commentsUI);

    // Add to top
    postsContainer.prepend(postDiv);
  }
</script>

</body>
</html>
